%% document class file for the preparation of a paper
%% for the International Conference ICCAS 2020
%% global option 'fleqn' ensures equations flush left.
%% set '10pt' and 'twocolumn' options.

\documentclass[10pt,twocolumn]{ICCAS}
 
%%%%%%% set heading and page number hear %%%%%%%%%%
% % Do not put page numbers for submission.
%\setcounter{page}{101}

\usepackage{diagbox}
\usepackage{subcaption}
\usepackage[hyphens]{url}  % Allows line breaks at hyphens
\usepackage[colorlinks]{hyperref}
\usepackage{array,tabularx}
\usepackage{multicol} 
\usepackage{multirow}
\usepackage{empheq}

\usepackage{amsmath, amssymb}

\begin{document}

\newcommand{\getErrorResult}[5]{\csname#1#2#3#4#5\endcsname}
\input{Uploaded/metrics_results}

\title{{\scshape Valinor}: a Lightweight Leg Inertial Odometry for Humanoid Robots}

\author{Arnaud Demont*${}^{1,2,3}$, Mehdi Benallegue${}^{1}$, Thomas Duvinage${}^{1}$, and Abdelaziz Benallegue${}^{1,2,3}$}

% \author{First A. Author${}^{1}$ and Second B. Author${}^{2*}$ }

% \affils{ ${}^{1}$Department of Electrical Engineering, Hankook University, \\
% Seoul, 13391, Korea (first@hankook.ac.kr) \\
% ${}^{2}$Department of Mechanical Engineering, Hankook University, \\
% Seoul, 13391, Korea (second@hankook.ac.kr) {\small${}^{*}$ Corresponding author}}

\affils{
${}^{1}$CNRS-AIST JRL (Joint Robotics Laboratory), IRL, National Institute of Advanced Industrial Science and Technology,\\  Tsukuba,  305-8560 Japan (arnaud.demont@aist.go.jp, mehdi.benallegue@aist.go.jp, thomas.duvinage@aist.go.jp). \\
${}^{2}$Université Paris-Saclay,   91190 Gif-sur-Yvette, France.\\
${}^{3}$Laboratoire d'Ingénierie des Systèmes de Versailles (LISV),\\   78140 Vélizy, France (arnaud.demont@uvsq.fr, abdelaziz.benallegue@uvsq.fr). \\ {\small${}^{*}$ Corresponding author}
}


\abstract{
This article presents {\scshape Valinor} (Velocity-Aided Leg Inertial Nonlinear Odometry and Registration), a method for Leg-Inertial odometry for humanoid robots addressing the challenge of lightweight yet accurate and certifiable state estimation. {\scshape Valinor} associates Leg odometry with the Tilt Observer, a computationally efficient complementary filter, which provides accurate estimates of the IMU's tilt and linear velocity with strong mathematical convergence guarantees. We introduce an axis-agnostic method for the fusion of the Leg odometry's yaw with the Tilt Observer's tilt estimate. We argue that this method is less arbitrary and more mathematically sound than those based on other orientation representations, especially on Euler angles.
We present an evaluation of the proposed estimator through real-world data on two humanoid robots. We show that, while being 7.5 times faster than the state-of-the-art method used for comparison, {\scshape Valinor} improves tilt estimation by over 25\%, making it a well-suited feedback for balance and walking controllers. 
}

\keywords{
    Lightweight state estimation, Humanoid robots, Proprioceptive odometry, Tilt estimation, Balancing.
}

\maketitle

%-----------------------------------------------------------------------

\section{Introduction}

Humanoid robot navigation in real-world environments remains a core challenge in robotics. Deploying robots at scale in society and industry requires strong guarantees on their ability to plan motion, and execute actions in real time, in order to ensure safe, predictable, and certifiable behavior.

In the meantime, methods for motion generation continue to gain in complexity and capability. Notably, Model Predictive Control (MPC)~\cite{Dallard2024AdiosStabilizers} and reinforcement learning-based controllers~\cite{Peters2003ReinforcmentLearningForHumanoid} are becoming more prevalent due to their ability to handle long-horizon planning, complex dynamics, and to their versatility. However, these advances come at the cost of increased computational complexity, running them in real-time on resource-limited platforms like embedded systems thus becomes challenging~\cite{findeisen2004computationalDelayNMPC}. Since the control part is getting heavier, one practical solution is to reduce the computational load of other parts of the pipeline. 

The state estimation part is one of the cornerstones of the pipeline, since other components depend on its output and often have to wait for it before executing, and thus cannot run in parallel. For this reason, there is a need for lightweight state estimation methods, which focus on improving the estimation of key variables at high frequency using the proprioceptive sensors readily available on the robot. The most common sensors for humanoids are joint encoders, inertial measurement units (IMUs) and contact force sensors such as FSR or force/torque sensors.

In this work we propose {\scshape Valinor} (Velocity-Aided Leg Inertial Nonlinear Odometry and Registration), a method for Leg-Inertial odometry for legged robots, which relies on a highly accurate tilt estimate provided by a nonlinear complementary filter~\cite{benallegue2020LyapunovStableOrientationEstimatorHumanoids}. This complementary filter allows for a much faster computation than the conventionally used Kalman Filter (e.g.~\cite{Hartley2020RIEKF}), and offers mathematical convergence guarantees on the tilt and linear velocity estimate. \\
The main contributions introduced in this paper are as follows:
\begin{itemize}
  \item The proposed state estimator is 7.5 times faster than the start-of-the-art method for proprioceptive odometry, while displaying on par odometry accuracy, and even improving significantly tilt estimation.
  \item We present the axis-agnostic tilt and yaw fusion, which we show to be more mathematically sound than that based on Euler angle representations.
  \item We evaluate the proposed method on real experiments with two different humanoid robots.
  \item The code of the Tilt Observer is open source\footnote{\scriptsize \url{https://github.com/ArnaudDmt/state-observation}}, as well as a ROS wrapper\footnote{\scriptsize \url{https://github.com/ArnaudDmt/state_observation_ros.git}}.
\end{itemize}
\noindent Figure~\ref{fig:summary} provides an overview of the Valinor's pipeline, outlining the contribution of each block and section.

\begin{figure*}[thb]
\begin{center}
\includegraphics[width=0.90\textwidth]{Uploaded/summary.jpg}
\caption{\label{fig:summary}Summary of {\scshape Valinor}'s pipeline.}
\end{center}
\end{figure*}
 


\section{Tilt Observer with Proof of Convergence} \label{sec:Tilt}
The robot's tilt is estimated by the \emph{Tilt Observer}, which relies on the signals from an IMU and on a linear velocity measurement. Since humanoid robots are generally not equipped with a direct sensor for linear velocity, we first explain how such a measurement can be reconstructed in the case of legged robot.

\subsection{Linear velocity pseudo-measurement}
The pseudo-measurement is obtained using the so-called \emph{anchor point}, a point rigidly attached to the robot whose velocity in the world frame is assumed to be zero. Under the common assumption that legged robot contacts remain fixed in the world, any point on a contact surface could serve as an anchor point. However, this assumption may be violated in the presence of slippage. To make the zero-velocity assumption as robust as possible, we compute the anchor point as a weighted average of all contact positions, assigning greater weight to those less prone to slip. Specifically, for each contact $i$, we calculate a coefficient $u_i$ from the measured contact force $\boldsymbol{F}_{i}$, quantifying its slip susceptibility according to Coulomb's law: 
\begin{equation}
    u_{i} = \frac{F_{i,z}}{\sqrt{F_{i,x}^2 + F_{i,y}^2} + \epsilon mg_{0}},\label{eq:ratio_ui}
\end{equation}
with $mg_{0}$ the weight of the robot, and $\epsilon$, an arbitrarily small term, which allows to deal with the case where the tangential force is zero. \\
We then normalize the coefficients to obtain $\lambda_i$ for each contact, which are subsequently used to weight their contributions in the average:
\begin{equation}
    \lambda_{i}=\frac{u_{i}}{\sum^{n_{c}}_{j=1}u_{j}}. \label{eq:lambda_i}
\end{equation}
Based on the definition of the anchor point, we give its position and linear velocity in the IMU's frame:
\begin{equation} 
{^{\mathcal{I}}}\boldsymbol{p}_{\mathcal{A}} = \sum^{n_{c}}_{i} \lambda_{i}  {^{\mathcal{I}}} \boldsymbol{p}_{{\mathcal{C}}_{i}} , \qquad \qquad {^{\mathcal{I}}} \dot{\boldsymbol{p}}_{\mathcal{A}} = \sum^{n_{c}}_{i} \lambda_{i}  {^{\mathcal{I}}} \dot{\boldsymbol{p}}_{{\mathcal{C}}_{i}}, \label{eq:imuAnchorKine} 
\end{equation} 
with ${^{\mathcal{I}}} \boldsymbol{p}_{{\mathcal{C}}_{i}}$ the position and ${^{\mathcal{I}}} \dot{\boldsymbol{p}}_{{\mathcal{C}}_{i}}$ the linear velocity of the $i$-th contact in the IMU's frame, which are directly provided by the robot's joint encoders and geometrical model.

Finally, we construct a pseudo-measurement $\boldsymbol{y}_v$ of the IMU's linear velocity in the world (expressed in the IMU frame) from the gyrometer signal $\boldsymbol{y}_g$, together with the anchor point's position and velocity in the IMU frame and its assumed zero velocity in the world:
\begin{equation}
    \boldsymbol{y}_v = - \boldsymbol{y}_{g} \times {^{\mathcal{I}}}\boldsymbol{p}_{\mathcal{A}} - {^{\mathcal{I}}} \dot{\boldsymbol{p}}_{\mathcal{A}} \label{eq:yv}
\end{equation}


\subsection{Definition of the Tilt Observer}
The Tilt Observer provides estimates of: 
\begin{itemize}
    \item $\boldsymbol{v}_{\mathcal{I}, \text{l}} \triangleq \boldsymbol{R}^{T}_{\mathcal{I}} \boldsymbol{v}_{\mathcal{I}} $ the linear velocity of the IMU's frame in the world frame, expressed in the frame of the IMU.
    \item $\boldsymbol{R}^{T}_{\mathcal{I}} \boldsymbol{e}_z$ the tilt of the IMU.
\end{itemize}
We thus define the state variables: 
\begin{alignat}{2}
&\boldsymbol{x}_{1} \triangleq \boldsymbol{v}_{\mathcal{I}, \text{l}} \quad &&, \boldsymbol{x}_{1} \in \mathbb{R}^{\text{3}}, \label{eq:x1} \\
&\boldsymbol{x}_{2} \triangleq \boldsymbol{R}^{T}_{\mathcal{I}} \boldsymbol{e}_z \quad &&, \boldsymbol{x}_{2} \in \mathbb{S}^{\text{2}}. \label{eq:x2}
\end{alignat} 
The set $\mathbb{S}^{\text{2}} \subset \mathbb{R}^{\text{3}}$ is the unit sphere centered at the origin, and defined as $\mathbb{S}^{\text{2}} = \left\{ \boldsymbol{x} \in \mathbb{R}^{\text{3}} \vert \lVert \boldsymbol{x} \rVert=\text{1} \right\}$.
The Tilt Observer consists in a complementary filter, which uses the system's dynamics as a feed-forward, and corrects the estimated state using the velocity measurement $\boldsymbol{y}_{v}$:
\begin{empheq}[left= \empheqlbrace]{align}
    \dot{\hat{\boldsymbol{x}}}_{1} &= - \boldsymbol{y}_{g} \times \hat{\boldsymbol{x}}_{1} - g_{0} \hat{\boldsymbol{x}}_{2}^{\prime} + \boldsymbol{y}_{a} + \alpha_{1} (\boldsymbol{y}_{v} - \hat{\boldsymbol{x}}_{1}) \text{, }\label{eq:tilt_dynamics_1} \\
    \dot{\hat{\boldsymbol{x}}}_{2}^{\prime} &= -  \boldsymbol{y}_{g} \times \hat{\boldsymbol{x}}_{2} - \frac{\alpha_{2}}{g_{0}} (\boldsymbol{y}_{v} - \hat{\boldsymbol{x}}_{1}) \text{, }\label{eq:tilt_dynamics_2} \\
    \dot{\hat{\boldsymbol{x}}}_{2} &= - (\boldsymbol{y}_{g} - \gamma \hat{\boldsymbol{x}}_{2} \times \hat{\boldsymbol{x}}_{2}^{\prime})\times \hat{\boldsymbol{x}}_{2} \text{. } \label{eq:tilt_dynamics_3}
\end{empheq}
$\hat{\boldsymbol{x}}_{1} $ is the estimate of $\boldsymbol{x}_{1} $ and $\hat{\boldsymbol{x}}_{2}^{\prime}$ is an intermediate estimate of $\boldsymbol{x}_{2} $, which converges exponentially, but is not restricted to lie on the sphere $\mathbb{S}^{\text{2}}$. This estimate drives the convergence of the tilt's final estimate $\hat{\boldsymbol{x}}_{2} $, which is explicitly projected onto $\mathbb{S}^{\text{2}}$ so as to respect its Lie group structure.
The positive scalar gains $\alpha_1$, $\alpha_2$ and $\gamma$ define the convergence rates of the three state estimates. Insights on their tuning are provided in~\cite{benallegue2023velocity}. 

The formulation as a complementary filter allows to conduct a convergence analysis of the estimation error, providing strong mathematical guarantees on the estimator's performances. Especially here, it has been shown in~\cite{benallegue2020LyapunovStableOrientationEstimatorHumanoids} that:
\begin{itemize}
    \item The dynamics of the estimation error is autonomous, and thus does not depend on the motion of the robot. 
    \item The intermediate estimator $\left\{\hat{\boldsymbol{x}}_{1}, \hat{\boldsymbol{x}}_{2}^{\prime} \right\}$ is \emph{globally exponentially stable}, with respect to the origin $\left(0,0\right)$.
    \item The full estimator is \emph{almost globally asymptotically stable}, and locally \emph{exponentially stable}. It provides a good filtering of noise and guarantees to respect the normality constraint.
\end{itemize}
Note that the filter's convergence guarantees hold regardless of the gains' tuning.

\section{Leg Odometry for Position and Yaw Estimation}\label{sec:Leg_odom}

While the tilt of the IMU's frame in the world frame is estimated by the Tilt Observer, its position and yaw are obtained using Leg odometry. Once a contact is created, its initial pose in the world is obtained by forward kinematics from the current IMU's frame pose and the robot's joint encoders. We call it the contact's \emph{reference} pose $\left\{ \boldsymbol{p}^{\star}_{\mathcal{C}}, \boldsymbol{R}^{\star}_{\mathcal{C}}\right\}$, which we consider constant to enforce the contact's anchoring role. This pose is then used to recover the pose of the IMU's frame in the world frame. 
With the proposed pipeline, we thus leverage both the accuracy and mathematical guarantees provided by the Tilt Observer, and the robustness to drift provided by the Leg odometry. Similarly to the computation of the anchor point, the contribution of contacts to the Leg odometry is weighted to trust more contacts which are the least prone to slippage, in order to mitigate its effect.

\section{Tilt--Yaw Fusion}
\label{sec:axisAgnostic}
%=====================================================================

The Tilt Observer of Section~\ref{sec:Tilt} provides $\hat{\boldsymbol{x}}_{2}$,  an accurate
estimate of the IMU \emph{tilt} noted
\(
  \boldsymbol{\ell}=\boldsymbol{R}_{1}^{\top}\boldsymbol{e}_{z},
\)
while the contact–based Leg odometry of
Section~\ref{sec:Leg_odom} supplies an orientation \(\boldsymbol{R}_{2} = \hat{\boldsymbol{R}}_{\mathcal{I}}\), whose
yaw reflects the robot's heading.  We now merge these two pieces into a single rotation \(\boldsymbol{R}\), which would preserve our tilt estimate, especially its mathematical convergence guarantees.

%.....................................................................
\subsection{Why not Euler angles?}
%.....................................................................

Classically in these situations, we use the Euler angles representation of the rotations,
\(\boldsymbol{R}_{1}=R_{z}(\psi_{1})R_{y}(\theta_{1})R_{x}(\phi_{1})\) and
\(\boldsymbol{R}_{2}=R_{z}(\psi_{2})R_{y}(\theta_{2})R_{x}(\phi_{2})\),
the textbook fusion is
\begin{equation}
  \boldsymbol{R}_{\mathrm{cl}}
  =R_{z}(\psi_{2})\,R_{y}(\theta_{1})\,R_{x}(\phi_{1}).
  \label{eq:fusion_classic}
\end{equation}
This solution has two properties
\begin{itemize} 
\item tilt is conserved, i.e. 
\(\boldsymbol{R}_{\mathrm{cl}}^{\top}\boldsymbol{e}_{z}=\boldsymbol{\ell}\).
\item among all rotations \(\hat{\boldsymbol{R}}\) such that
\(\hat{\boldsymbol{R}}^{\top}\boldsymbol{e}_{z}=\boldsymbol{\ell}\),
\(R_{\mathrm{cl}}\) minimises the horizontal error
\(
  \|
    \hat{\boldsymbol{R}}^{\top}\boldsymbol{e}_{x}-\boldsymbol{R}_{2}^{\top}\boldsymbol{e}_{x}
  \|^{2}.
\)
\end{itemize}


Despite its simplicity, Eq.~\eqref{eq:fusion_classic} rests on two tacit
assumptions that are seldom met in the leg–inertial setting considered
here:

\begin{itemize} 
\item The optimality of \eqref{eq:fusion_classic} is defined with
      respect to the IMU axis $\boldsymbol{e}_{x}$ only.  
      This makes sense when $\boldsymbol{e}_{x}$ \emph{is} the heading
      carrier, for example with a GPS-based heading for wheeled vehicles.  
      In practice the IMU can be installed with an arbitrary yaw
      offset, as in {\scshape{Valinor}} where yaw information comes from Leg odometry
      (Section~\ref{sec:Leg_odom}), not from
      that axis.  Treating $\boldsymbol{e}_{x}$ as ``special'' therefore
      introduces a systematic bias.

\item Because \eqref{eq:fusion_classic} uses a ZYX decomposition of
      $\boldsymbol{R}_{1}$, it inherits the Euler-angle singularity at
      $\theta_{1}= \pm 90^{\circ}$.  
      Exactly there the pitch axis aligns with
      $\boldsymbol{e}_{z}$, roll and yaw collapse, and the horizontal
      projection of $\boldsymbol{e}_{x}$ disappears, leaving the yaw
      numerically indeterminate.  
      Such attitudes are frequent in humanoids that perform
      multicontact motions.
\end{itemize}
To avoid these two issues we adopt an \emph{axis-agnostic} fusion that
uses solely the measured tilt $\boldsymbol{\ell}$, allows any horizontal
vector to encode yaw, and remains regular for all configurations except
the physically undefined case $\boldsymbol{\ell}=-\boldsymbol{e}_{z}$.\\
The construction is detailed next.

%---------------------------------------------------------------------
\subsection{Yaw without Euler angles}
\label{sec:yaw_no_euler}
%---------------------------------------------------------------------

The yaw contained in $\boldsymbol{R}_{2}$ can be extracted without decomposing the
matrix into Euler angles.  Let $\boldsymbol{r}_{2}$ denote the third column of $\boldsymbol{R}_{2}$.
This column describes the world coordinates of the body $\boldsymbol{z}$-axis, i.e $\boldsymbol{r}_{2}=\boldsymbol{R}_{2}\boldsymbol{e}_z$, which is not the tilt of $\boldsymbol{R}_{2}$. 
It is used to build the horizontal vector $\boldsymbol{m}_2$:
\begin{equation}
  \scriptstyle{
  \boldsymbol{m}_2
  =
  \begin{cases}
    \boldsymbol{e}_x, &
    \text{if } {r}_{2,x}^{2}+{r}_{2,y}^{2}\simeq0,\\[6pt]
      \dfrac{1}{\sqrt{{r}_{2,x}^{2}+{r}_{2,y}^{2}}} [{r}_{2,y}\;-{r}_{2,x}\;0]^{\top},
    & \text{otherwise.}
  \end{cases}
  }
\end{equation}
where ${r}_{2,x}$ and ${r}_{2,y}$ are the first and second components of $\boldsymbol{r}_{2}$. 
The condition ${r}_{2,x}^{2}+{r}_{2,y}^{2}\simeq0$ occurs when the tilt $\boldsymbol{R}_{2}^T \boldsymbol{e}_z$ is vertical (upward or downward), so we take $\boldsymbol{m}=\boldsymbol{e_x}$ to avoid the singularity.
Otherwise, the vector $\boldsymbol{m}_2$ always exists and is unique.

Rotating $\boldsymbol{m}_2$ by $\boldsymbol{R}_{2}^T$
results in another vector
$\tilde{\boldsymbol{m}}_2=\boldsymbol{R}_{2}^T\boldsymbol{m}_2$, which is horizontal as well.
This means that  $\boldsymbol{m}_2$ is an invariant horizontal vector. 

We define the yaw of~$\boldsymbol{R}_{2}$, as the angle between these two vectors $\boldsymbol{m}_2$ and $\tilde{\boldsymbol{m}}_2$, which is computed as
\begin{equation}
  \theta
  =
  \operatorname{atan2}\Bigl(
     {m}_{2,x}\tilde{{m}}_{2,y}
    -{m}_{2,y}\tilde{{m}}_{2,x},\;
     {m}_{2,x}\tilde{{m}}_{2,x}
    +{m}_{2,y}\tilde{{m}}_{2,y}
  \Bigr),
  \label{eq:yaw_theta}
\end{equation}
where the $x$ and $y$ subscripts denote the first and second components of the corresponding vector. 
The use of horizontal invariant vectors to define the yaw angle guarantees that we only consider rotations around the vertical axis, giving the most sound definition of yaw.

When the tilt $\boldsymbol{R}_{2}^T \boldsymbol{e}_z$ is vertical, any horizontal vector is invariant. In such a case, taking $\boldsymbol{m}=\boldsymbol{e_x}$ amounts at mimicking Euler yaw angle. 
When this tilt is downward, meaning $\boldsymbol{R}_{2}$ is a rotation of $\pi$ around a horizontal axis, the concept of yaw itself is ill-defined. When the tilt is upward, any horizontal vector gives the same yaw, so using Euler's yaw angle by taking  $\boldsymbol{m}_2=\boldsymbol{e_x}$ is a valid choice.

 Fortunately we don't have to compute this angle explicitly to perform the merge. It can be done directly using the tilt $\boldsymbol{\ell}$ and the second matrix $\boldsymbol{R}_{2}$.

%---------------------------------------------------------------------
\subsection{Axis-agnostic triad fusion}
\label{sec:triad_fusion}
%---------------------------------------------------------------------

\subsubsection{Select a proper reference vector}
Similarly to the yaw computation above, we start with the selection of the reference vector. However, the fusion makes this step slightly more subtile than just identifying the yaw of a single matrix, because the two rotations could have a very different tilt. This could lead the tilt vector $\boldsymbol{\ell}$ to be nearly colinear with the rotated horizontal invariant vector $\boldsymbol{R}_{2}^T\boldsymbol{m}_2$. This would make the fusion singular. 

The solution is to find a reference vector that is both horizontal and orthogonal to the real up direction $\boldsymbol{r}=\boldsymbol{R}_{2}\boldsymbol{\ell}=[v_{x}\;v_{y}\;v_{z}]^{\top}$.
Consequently, a proper reference vector can be defined as
\begin{equation}
  \scriptstyle{
  \boldsymbol{m}
  =
  \begin{cases}
    \boldsymbol{m}_2, &
      \text{if } v_{x}^{2}+v_{y}^{2}\simeq0,\\[6pt]
    \dfrac{1}{\sqrt{v_{x}^{2}+v_{y}^{2}}}\,[v_{y}\;-v_{x}\;0]^{\top},
    & \text{otherwise.}
  \end{cases}
  }
\end{equation}
The degenerate case occurs only when $\boldsymbol{r}$ is vertical, corresponding to $\boldsymbol{R}_{2}^{T}\boldsymbol{e}_{z} = \boldsymbol{\ell}$, which means the rotations nearly have the same tilt. In this situation we know that $\boldsymbol{\ell}$ and $\boldsymbol{R}_{2}^T\boldsymbol{m}_2$ are nearly orthogonal. We thus safely use the yaw angle definition of the previous section. We define the vector $\boldsymbol{m}$ expressed in the frame of $\boldsymbol{R}_{2}$ as 
$\boldsymbol{m}_{l}=R_{2}^{\top}\boldsymbol{m}$.


\subsubsection{ Build two right-handed bases.}
Using cross products, form
\begin{align}
  \boldsymbol{B}_{1}
  &=
  \left[
    \boldsymbol{m}\times\boldsymbol{e}_{z}\quad
    \boldsymbol{e}_{z}\times\boldsymbol{m}\times\boldsymbol{e}_{z}\quad
    \boldsymbol{e}_{z}
  \right],\\
  \boldsymbol{B}_{2}
  &=
  \left[
    \frac{\boldsymbol{m}_{l}\times\boldsymbol{\ell}}
         {\|\boldsymbol{m}_{l}\times\boldsymbol{\ell}\|}\quad
    \frac{\boldsymbol{\ell}\times\boldsymbol{m}_{l}\times\boldsymbol{\ell}}
         {\|\boldsymbol{m}_{l}\times\boldsymbol{\ell}\|}\quad
    \boldsymbol{\ell}
  \right].
\end{align}
Each matrix is orthonormal: the first column is the chosen horizontal
vector, the third column is the vertical direction, and the second
column completes a right-handed frame.

\subsubsection{ Fuse tilt and yaw.}
The desired rotation is obtained by rotating from the basis
$\{\boldsymbol{m}_{2},\cdot,\boldsymbol{\ell}\}$ to
$\{\boldsymbol{m},\cdot,\boldsymbol{e}_{z}\}$:
\begin{equation}
  \boldsymbol{R} = \boldsymbol{B}_{1}\,\boldsymbol{B}_{2}^{\top}.
  \label{eq:fused_R}
\end{equation}



%.....................................................................
\subsection{Properties}
%.....................................................................

The rotation obtained with Eq.~\eqref{eq:fused_R} has the following
properties:

\begin{itemize} 
  \item \emph{Tilt preservation}:  
        \(\boldsymbol{R}^{\top}\boldsymbol{e}_{z}=\boldsymbol{\ell}\).

  \item \emph{Optimal horizontal alignment}:  
        for any rotation \(\hat{\boldsymbol{R}}\) satisfying
        \(\hat{\boldsymbol{R}}^{\top}\boldsymbol{e}_{z}=\boldsymbol{\ell}\),
        the choice \eqref{eq:fused_R} minimises $\bigl\|
             \hat{\boldsymbol{R}}^{\top}\boldsymbol{m}-\boldsymbol{m}_{l}
          \bigr\|^{2}$.
        The proof follows exactly the one–parameter maximisation used
        for the Euler fusion, but with the task-specific direction
        \(\boldsymbol{m}\) in place of the body axis
        \(\boldsymbol{e}_{x}\).

  \item \emph{Singularity}:  
        the construction is undefined only when
        \(\boldsymbol{\ell}=-\boldsymbol{e}_{z}\); at that upside-down
        pose, yaw itself has no meaning.

  \item \emph{Computation}:  
        implementation requires only vector cross products and
        normalisations, with no Euler-angle extraction, keeping the cost
        compatible with real-time embedded execution.
\end{itemize}

The axis-agnostic fusion is therefore adopted as the default in {\scshape Valinor}; it avoids the arbitrary preference for the body axis \(\boldsymbol{e}_{x}\), takes into account the difference of tilt and avoids the gimbal-lock issues of Eq.~\eqref{eq:fusion_classic}. 



\section{Experimental Evaluation}

The proposed estimator has been compared to the state-of-the-art RI-EKF~\cite{Hartley2020RIEKF}, accross two experimental scenarios on two different humanoid robots:
\begin{itemize}
    \item Experiment 1: A walk on a flat ground over about 18 meters with the robot RHP Friends. This experiment was repeated 5 times, for a total distance of about 90 meters.
    \item Experiment 2: A multi-contact motion over about 2 meters with the robot HRP-5P. This motion involved an additional contact at the robot's left hand, and non-coplanar contacts on tilted obstacles. This experiment was repeated 4 times for a total distance of about 8 meters.
\end{itemize}
\subsection{Computational Performance Evaluation}\label{subsec:computation_time}

We first evaluated the computation speed performance of the proposed estimator on a laptop with an Intel Xeon E-2176M CPU (2.70GHz x 12), over the four multi-contact experiments. In average, an iteration of {\scshape Valinor} was computed in 2.547 \textmu s, against 19.315 \textmu s for the RI-EKF. It is thus more than 7.5 times faster, while proposing equivalent estimation accuracy, or even improving the estimation of key variables, as shown in Table~\ref{tab:estimation_eval}.

\subsection{Estimation Accuracy Evaluation} ~\label{subsec:est_accur_eval}

\begin{table}[h!] 
\setlength{\extrarowheight}{0.6ex}
\addtolength{\tabcolsep}{-0.4em}
\caption{Mean and standard deviation (in parentheses) of the estimation errors during the four trials of Experiment 2. RE is the The 0.3 m Relative Error. } \label{tab:estimation_eval}
{\footnotesize
    \begin{center}
        \begin{tabu}to\linewidth{| X[c] | X[c] | X[c] | X[c] | X[c] | X[c] | X[c] |}
            \hline
                  &       \multicolumn{2}{c|}{RE Translation}         &    \multicolumn{2}{c|}{RE Orientation}  &    \multicolumn{2}{c|}{Linear velocity}     \\     

            &       \multicolumn{2}{c|}{[m]}         &    \multicolumn{2}{c|}{ [\textdegree] }  &    \multicolumn{2}{c|}{[$\text{m/s}$]}     \\     
                  
            \cline{2-7}
              &     Lateral    &      Vertical      &   \multirow{2}{*}{Tilt}      &     \multirow{2}{*}{Yaw}    &  Lateral  &  Vertical \\ 
              &    \{$\boldsymbol{x}, \boldsymbol{y}$\}    &     $\boldsymbol{z}$      &      &      &   \{$\boldsymbol{x}, \boldsymbol{y}$\}  &  $\boldsymbol{z}$ \\
            \hline     
            \multirow{2}{*}{Ours}  &  \textbf{\getErrorResult{Multicontact}{Tilt}{Relerror}{Transxy}{Meanabs}}  &  \textbf{\getErrorResult{Multicontact}{Tilt}{Relerror}{Transz}{Meanabs}}   &    \textbf{\getErrorResult{Multicontact}{Tilt}{Relerror}{Tilt}{Meanabs}}    &    \textbf{\getErrorResult{Multicontact}{Tilt}{Relerror}{Yaw}{Meanabs}}     &  \getErrorResult{Multicontact}{Tilt}{Velerror}{EstimateXy}{Meanabs}    &   \textbf{\getErrorResult{Multicontact}{Tilt}{Velerror}{EstimateZ}{Meanabs}}  \\ 
               &  (\getErrorResult{Multicontact}{Tilt}{Relerror}{Transxy}{Std})   &      (\getErrorResult{Multicontact}{Tilt}{Relerror}{Transz}{Std})      &   (\getErrorResult{Multicontact}{Tilt}{Relerror}{Tilt}{Std})   &     (\getErrorResult{Multicontact}{Tilt}{Relerror}{Yaw}{Std})   &  (\getErrorResult{Multicontact}{Tilt}{Velerror}{EstimateXy}{Std})   &   (\getErrorResult{Multicontact}{Tilt}{Velerror}{EstimateZ}{Std})  \\ 
            \hline
            RI-EKF  &  \getErrorResult{Multicontact}{Hartley}{Relerror}{Transxy}{Meanabs}  &   \getErrorResult{Multicontact}{Hartley}{Relerror}{Transz}{Meanabs}   &    \getErrorResult{Multicontact}{Hartley}{Relerror}{Tilt}{Meanabs}    &    \getErrorResult{Multicontact}{Hartley}{Relerror}{Yaw}{Meanabs}   &  \textbf{\getErrorResult{Multicontact}{Hartley}{Velerror}{EstimateXy}{Meanabs}}    &   \getErrorResult{Multicontact}{Hartley}{Velerror}{EstimateZ}{Meanabs}  \\ 
            \cite{Hartley2020RIEKF} & (\getErrorResult{Multicontact}{Hartley}{Relerror}{Transxy}{Std})    &     (\getErrorResult{Multicontact}{Hartley}{Relerror}{Transz}{Std})    &     (\getErrorResult{Multicontact}{Hartley}{Relerror}{Tilt}{Std})   &    (\getErrorResult{Multicontact}{Hartley}{Relerror}{Yaw}{Std})    &  (\getErrorResult{Multicontact}{Hartley}{Velerror}{EstimateXy}{Std})    &   (\getErrorResult{Multicontact}{Hartley}{Velerror}{EstimateZ}{Std})  \\ 
            \hline     
        \end{tabu}
    \end{center}
}
\end{table}

These results show that {\scshape Valinor} improved the estimation of lateral translations by over 40\% compared to the RI-EKF, and improved that of the robot's tilt by 60\%. For both translations and tilt estimates, our method displayed a significantly lower standard deviation of the error, proving an improved estimation consistency. 


%%%%%%%%%%%%%%%%% BIBLIOGRAPHY IN THE LaTeX file !!!!! %%%%%%%%%%%%%%%%%%%%%%
%%---------------------------------------------------------------------------%%
%
% \begin{thebibliography}{99}

% \bibitem{ref1}
% J. H. Bong, ``Controlling the parasite,'' in \textit{Proc. of International Conference on Control, Automation and Systems}, pp. 0209-0210, 2020


% \bibitem{ref2}
% A. Alice and B. Bob, ``Nonlinear unstable systems,'' \textit{International Journal of Control, Automation, and Systems}, vol. 23, no. 4, pp. 123–145, 1989.

% \bibitem{ref3}
% M. Young, \textit{The Technical Writer's Handbook}, Mill Valley, Seoul, 1989.



% \end{thebibliography}
% %
% %%--------------------------------------------------------------------%%

\bibliographystyle{IEEEtran}
\bibliography{IEEEabrv, Uploaded/Bibliography}

\end{document}
